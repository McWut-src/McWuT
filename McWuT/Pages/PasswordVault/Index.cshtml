@page
@model McWuT.Web.Pages.PasswordVault.IndexModel
@{
    ViewData["Title"] = "Password Vault";
}

@section Styles {
    <link rel="stylesheet" href="~/css/password-vault.css" />
}

<div class="password-vault">
    <div class="container-fluid py-4">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="toast-container">
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="bi bi-check-circle text-success me-2"></i>
                        <strong class="me-auto">Success</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        @TempData["SuccessMessage"]
                    </div>
                </div>
            </div>
        }

        <div class="vault-card">
            <div class="vault-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-1"><i class="bi bi-shield-lock me-2"></i>Password Vault</h1>
                        <p class="mb-0 opacity-75">Secure password management for all your accounts</p>
                    </div>
                    <button type="button" class="btn btn-light btn-lg" onclick="showAddForm()">
                        <i class="bi bi-plus-circle me-2"></i>Add Entry
                    </button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="vault-search">
                <form method="get" id="searchForm">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control form-control-lg" name="SearchTerm" 
                                       value="@Model.SearchTerm" placeholder="Search by name, website, username, or category..."
                                       onkeyup="debounceSearch()" id="searchInput">
                                <button type="button" class="btn btn-outline-secondary" onclick="clearSearch()">
                                    <i class="bi bi-x-circle"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-primary" onclick="exportData()">
                                    <i class="bi bi-download me-1"></i>Export
                                </button>
                                <button type="button" class="btn btn-outline-info" onclick="importData()">
                                    <i class="bi bi-upload me-1"></i>Import
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Add/Edit Form -->
            <div id="entryForm" class="entry-form" style="display: none;">
                <form id="entryFormElement" method="post">
                    <input type="hidden" id="editingId" name="EditingId" />
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input asp-for="Input.Name" class="form-control" placeholder="Entry Name" required />
                                <label asp-for="Input.Name"><i class="bi bi-tag me-1"></i>Entry Name *</label>
                                <span asp-validation-for="Input.Name" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input asp-for="Input.Website" class="form-control" placeholder="Website" />
                                <label asp-for="Input.Website"><i class="bi bi-globe me-1"></i>Website</label>
                                <span asp-validation-for="Input.Website" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input asp-for="Input.Username" class="form-control" placeholder="Username" />
                                <label asp-for="Input.Username"><i class="bi bi-person me-1"></i>Username</label>
                                <span asp-validation-for="Input.Username" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input asp-for="Input.Category" class="form-control" list="categoryOptions" placeholder="Category" />
                                <label asp-for="Input.Category"><i class="bi bi-tag me-1"></i>Category</label>
                                <datalist id="categoryOptions">
                                    <option value="Social Media"></option>
                                    <option value="Banking"></option>
                                    <option value="Work"></option>
                                    <option value="Email"></option>
                                    <option value="Shopping"></option>
                                    <option value="Entertainment"></option>
                                    <option value="Utilities"></option>
                                    <option value="Other"></option>
                                </datalist>
                                <span asp-validation-for="Input.Category" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                <div class="input-group">
                                    <div class="form-floating flex-grow-1">
                                        <input asp-for="Input.Password" class="form-control password-field" type="password" 
                                               id="passwordInput" placeholder="Password" />
                                        <label asp-for="Input.Password"><i class="bi bi-key me-1"></i>Password</label>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('passwordInput')">
                                        <i class="bi bi-eye" id="passwordToggleIcon"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-info" onclick="generatePassword()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </div>
                                <span asp-validation-for="Input.Password" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="form-floating">
                                <textarea asp-for="Input.Notes" class="form-control" placeholder="Notes" rows="3"></textarea>
                                <label asp-for="Input.Notes"><i class="bi bi-journal-text me-1"></i>Notes</label>
                                <span asp-validation-for="Input.Notes" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="hideForm()">
                                    <i class="bi bi-x-circle me-1"></i>Cancel
                                </button>
                                <button type="submit" class="btn btn-primary" id="submitBtn">
                                    <i class="bi bi-check-circle me-1"></i>Save Entry
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Entries List -->
            <div class="vault-body p-3">
                @if (Model.Entries.Any())
                {
                    <div id="entriesContainer">
                        @foreach (var entry in Model.Entries)
                        {
                            <div class="entry-card fade-in" data-entry-id="@entry.UniqueId">
                                <div class="entry-header">
                                    <h5 class="entry-title">
                                        <i class="bi bi-shield-check text-success me-2"></i>
                                        @entry.Name
                                    </h5>
                                    <div class="entry-actions">
                                        <button type="button" class="btn btn-outline-primary btn-sm" 
                                                onclick="editEntry('@entry.UniqueId')" title="Edit">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-danger btn-sm" 
                                                onclick="deleteEntry('@entry.UniqueId')" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="entry-details">
                                    @if (!string.IsNullOrEmpty(entry.Website))
                                    {
                                        <div class="detail-item">
                                            <i class="bi bi-globe detail-icon"></i>
                                            <span class="detail-text">@entry.Website</span>
                                            <button class="copy-btn" onclick="copyToClipboard('@entry.Website', this)" title="Copy URL">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(entry.Username))
                                    {
                                        <div class="detail-item">
                                            <i class="bi bi-person detail-icon"></i>
                                            <span class="detail-text">@entry.Username</span>
                                            <button class="copy-btn" onclick="copyToClipboard('@entry.Username', this)" title="Copy Username">
                                                <i class="bi bi-clipboard"></i>
                                            </button>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(entry.EncryptedPassword))
                                    {
                                        <div class="detail-item">
                                            <i class="bi bi-key detail-icon"></i>
                                            <span class="detail-text">••••••••••</span>
                                            <div class="btn-group">
                                                <button class="copy-btn" onclick="revealAndCopyPassword('@entry.UniqueId', this)" title="Copy Password">
                                                    <i class="bi bi-clipboard-check"></i>
                                                </button>
                                                <button class="copy-btn" onclick="revealPassword('@entry.UniqueId', this)" title="Show Password">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                            </div>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(entry.Category))
                                    {
                                        <div class="detail-item">
                                            <i class="bi bi-tag detail-icon"></i>
                                            <span class="category-badge">@entry.Category</span>
                                        </div>
                                    }

                                    @if (!string.IsNullOrEmpty(entry.Notes))
                                    {
                                        <div class="detail-item" style="grid-column: 1 / -1;">
                                            <i class="bi bi-journal-text detail-icon"></i>
                                            <span class="detail-text text-muted">@entry.Notes</span>
                                        </div>
                                    }

                                    <div class="detail-item" style="grid-column: 1 / -1;">
                                        <i class="bi bi-clock detail-icon"></i>
                                        <span class="detail-text text-muted small">
                                            Last updated: @((entry.UpdatedAt ?? entry.CreatedAt).ToString("MMM dd, yyyy 'at' h:mm tt"))
                                        </span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Pagination -->
                    @if (Model.TotalPages > 1)
                    {
                        <nav aria-label="Password entries pagination" class="mt-4">
                            <ul class="pagination justify-content-center">
                                @if (Model.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="?currentPage=@(Model.CurrentPage - 1)&searchTerm=@Model.SearchTerm">
                                            <i class="bi bi-chevron-left me-1"></i>Previous
                                        </a>
                                    </li>
                                }

                                @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                                {
                                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                        <a class="page-link" href="?currentPage=@i&searchTerm=@Model.SearchTerm">@i</a>
                                    </li>
                                }

                                @if (Model.CurrentPage < Model.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="?currentPage=@(Model.CurrentPage + 1)&searchTerm=@Model.SearchTerm">
                                            Next<i class="bi bi-chevron-right ms-1"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    }
                }
                else
                {
                    <div class="empty-state">
                        <i class="bi bi-shield-exclamation"></i>
                        <h4>No password entries found</h4>
                        <p class="mb-4">
                            @if (!string.IsNullOrEmpty(Model.SearchTerm))
                            {
                                <span>No entries match your search criteria. Try adjusting your search terms.</span>
                            }
                            else
                            {
                                <span>Start by adding your first password entry to secure your digital life.</span>
                            }
                        </p>
                        <button type="button" class="btn btn-primary btn-lg" onclick="showAddForm()">
                            <i class="bi bi-plus-circle me-2"></i>Add First Entry
                        </button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <form style="display: none;">
        @Html.AntiForgeryToken()
    </form>

    <script>
        let searchTimeout;
        let isEditing = false;

        // Toast notification system
        function showToast(message, type = 'success') {
            const toastHtml = `
                <div class="toast show" role="alert">
                    <div class="toast-header">
                        <i class="bi bi-${type === 'success' ? 'check-circle text-success' : 'exclamation-circle text-danger'} me-2"></i>
                        <strong class="me-auto">${type === 'success' ? 'Success' : 'Error'}</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;
            
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            
            container.insertAdjacentHTML('beforeend', toastHtml);
            
            setTimeout(() => {
                const toast = container.lastElementChild;
                if (toast) toast.remove();
            }, 5000);
        }

        // Search functionality
        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                document.getElementById('searchForm').submit();
            }, 500);
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            window.location.href = window.location.pathname;
        }

        // Form management
        function showAddForm() {
            isEditing = false;
            document.getElementById('editingId').value = '';
            document.getElementById('entryForm').style.display = 'block';
            document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>Save Entry';
            document.getElementById('entryFormElement').action = '?handler=Create';
            
            // Clear form
            document.getElementById('Input_Name').value = '';
            document.getElementById('Input_Website').value = '';
            document.getElementById('Input_Username').value = '';
            document.getElementById('passwordInput').value = '';
            document.getElementById('Input_Category').value = '';
            document.getElementById('Input_Notes').value = '';
            
            document.getElementById('Input_Name').focus();
        }

        function hideForm() {
            document.getElementById('entryForm').style.display = 'none';
            isEditing = false;
        }

        async function editEntry(id) {
            try {
                const response = await fetch(`?handler=Edit&id=${id}`, {
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    isEditing = true;
                    document.getElementById('editingId').value = data.id;
                    document.getElementById('Input_Name').value = data.name || '';
                    document.getElementById('Input_Website').value = data.website || '';
                    document.getElementById('Input_Username').value = data.username || '';
                    document.getElementById('passwordInput').value = '';
                    document.getElementById('Input_Category').value = data.category || '';
                    document.getElementById('Input_Notes').value = data.notes || '';
                    
                    document.getElementById('submitBtn').innerHTML = '<i class="bi bi-check-circle me-1"></i>Update Entry';
                    document.getElementById('entryFormElement').action = '?handler=Update';
                    document.getElementById('entryForm').style.display = 'block';
                    
                    document.getElementById('Input_Name').focus();
                } else {
                    showToast('Failed to load entry data', 'error');
                }
            } catch (error) {
                showToast('Error loading entry data', 'error');
                console.error(error);
            }
        }

        async function deleteEntry(id) {
            if (!confirm('Are you sure you want to delete this password entry? This action cannot be undone.')) {
                return;
            }

            try {
                const formData = new FormData();
                formData.append('id', id);
                
                const response = await fetch('?handler=Delete', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        showToast(result.message);
                        document.querySelector(`[data-entry-id="${id}"]`).remove();
                        
                        // Check if page is empty and reload if needed
                        if (document.querySelectorAll('.entry-card').length === 0) {
                            setTimeout(() => window.location.reload(), 1000);
                        }
                    } else {
                        showToast(result.message, 'error');
                    }
                } else {
                    showToast('Failed to delete entry', 'error');
                }
            } catch (error) {
                showToast('Error deleting entry', 'error');
                console.error(error);
            }
        }

        // Password functionality
        function togglePasswordVisibility(inputId) {
            const passwordInput = document.getElementById(inputId);
            const toggleIcon = document.getElementById('passwordToggleIcon');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'bi bi-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'bi bi-eye';
            }
        }

        function generatePassword() {
            const length = 16;
            const charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@@#$%^&*()_+-=[]{}|;:,.<>?";
            let password = "";
            
            // Ensure at least one character from each category
            const lowercase = "abcdefghijklmnopqrstuvwxyz";
            const uppercase = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            const numbers = "0123456789";
            const symbols = "!@@#$%^&*()_+-=[]{}|;:,.<>?";
            
            password += lowercase[Math.floor(Math.random() * lowercase.length)];
            password += uppercase[Math.floor(Math.random() * uppercase.length)];
            password += numbers[Math.floor(Math.random() * numbers.length)];
            password += symbols[Math.floor(Math.random() * symbols.length)];
            
            // Fill the rest randomly
            for (let i = 4; i < length; i++) {
                password += charset[Math.floor(Math.random() * charset.length)];
            }
            
            // Shuffle the password
            password = password.split('').sort(() => Math.random() - 0.5).join('');
            
            document.getElementById('passwordInput').value = password;
            document.getElementById('passwordInput').type = 'text';
            document.getElementById('passwordToggleIcon').className = 'bi bi-eye-slash';
            
            showToast('Strong password generated!');
        }

        async function revealPassword(entryId, button) {
            try {
                const formData = new FormData();
                formData.append('entryId', entryId);
                
                const response = await fetch('?handler=RevealPassword', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    const detailText = button.parentElement.previousElementSibling;
                    const originalText = detailText.textContent;
                    
                    detailText.textContent = data.password;
                    detailText.classList.add('password-field');
                    button.innerHTML = '<i class="bi bi-eye-slash"></i>';
                    button.title = 'Hide Password';
                    
                    // Hide password after 10 seconds
                    setTimeout(() => {
                        detailText.textContent = '••••••••••';
                        detailText.classList.remove('password-field');
                        button.innerHTML = '<i class="bi bi-eye"></i>';
                        button.title = 'Show Password';
                    }, 10000);
                } else {
                    showToast('Failed to retrieve password', 'error');
                }
            } catch (error) {
                showToast('Error retrieving password', 'error');
                console.error(error);
            }
        }

        async function revealAndCopyPassword(entryId, button) {
            try {
                const formData = new FormData();
                formData.append('entryId', entryId);
                
                const response = await fetch('?handler=RevealPassword', {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    await navigator.clipboard.writeText(data.password);
                    
                    const originalIcon = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check"></i>';
                    button.classList.add('copied');
                    
                    setTimeout(() => {
                        button.innerHTML = originalIcon;
                        button.classList.remove('copied');
                    }, 2000);
                    
                    showToast('Password copied to clipboard!');
                } else {
                    showToast('Failed to copy password', 'error');
                }
            } catch (error) {
                showToast('Error copying password', 'error');
                console.error(error);
            }
        }

        // Copy to clipboard functionality
        async function copyToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                
                const originalIcon = button.innerHTML;
                button.innerHTML = '<i class="bi bi-check"></i>';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.innerHTML = originalIcon;
                    button.classList.remove('copied');
                }, 2000);
                
                showToast('Copied to clipboard!');
            } catch (error) {
                showToast('Failed to copy to clipboard', 'error');
                console.error(error);
            }
        }

        // Import/Export functionality (placeholder)
        function exportData() {
            showToast('Export functionality coming soon!', 'info');
        }

        function importData() {
            showToast('Import functionality coming soon!', 'info');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-hide toasts
            setTimeout(() => {
                const toasts = document.querySelectorAll('.toast');
                toasts.forEach(toast => {
                    if (toast.classList.contains('show')) {
                        toast.remove();
                    }
                });
            }, 5000);
        });
    </script>
}